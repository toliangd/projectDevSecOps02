pipeline { // В нее мы оборачиваем наш код.
    agent any
    environment {
        registry = 'tolikgd/microblog'
        registryCred = 'dockerhub'
    }

    stages {
        stage('test') {
            agent {node {label 'master'}}
            steps {
                sh 'docker info'
            }
        }
        stage('Сборка, отправка и зачистка') {
            steps {
                script {
                    dockerImage = docker.build registry + ":$BUILD_NUMBER"
                    docker.withRegistry('', registryCred) {
                    dockerImage.push()
                    }
                    sh 'docker rmi $registry:$BUILD_NUMBER'
                }
            }
        }
        stage('Тестирование_1') {
            steps {
                sh 'docker run aquasec/trivy $registry:$BUILD_NUMBER >> rezult-$BUILD_NUMBER'
                sh 'HIGH=$(cat rezult-$BUILD_NUMBER | grep HIGH | wc -l); echo "$HIGH"; if [[ $HIGH -gt 2 ]]; then exit 1; fi'
            }
        }
        stage('Тестирование_2') {
            agent {node {label 'docker'}}
            steps {
                sh 'grype $registry:$BUILD_NUMBER --scope all-layers'
            }
        }
        stage('Разветрывание') {
            steps {
                echo 'Развертывание'
            }
        }
    }
}